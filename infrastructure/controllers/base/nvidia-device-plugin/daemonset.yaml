apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nvidia-device-plugin-daemonset
  namespace: nvidia-device-plugin
  labels:
    app: nvidia-device-plugin
spec:
  selector:
    matchLabels:
      name: nvidia-device-plugin-ds
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        name: nvidia-device-plugin-ds
    spec:
      tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
      - effect: NoSchedule
        operator: Exists
      priorityClassName: "system-node-critical"
      serviceAccountName: nvidia-device-plugin
      initContainers:
      - name: wait-for-nvidia-toolkit
        image: ubuntu:24.04
        command:
        - /bin/bash
        - -c
        - |
          echo "Waiting for NVIDIA toolkit installation..."
          while [ ! -f /host/tmp/nvidia-k3s-configured ]; do
            echo "Waiting for K3s to be configured with NVIDIA support..."
            sleep 10
          done
          echo "NVIDIA toolkit configuration detected, proceeding..."
        volumeMounts:
        - name: host-tmp
          mountPath: /host/tmp
          readOnly: true
      containers:
      - image: nvcr.io/nvidia/k8s-device-plugin:v0.14.5
        name: nvidia-device-plugin-ctr
        args:
        - "--fail-on-init-error=false"
        - "--device-list-strategy=envvar"
        - "--device-id-strategy=uuid"
        - "--pass-device-specs=true"
        - "--mig-strategy=none"
        env:
        - name: NVIDIA_VISIBLE_DEVICES
          value: "all"
        - name: NVIDIA_DRIVER_CAPABILITIES
          value: "compute,utility"
        - name: NVIDIA_DRIVER_ROOT
          value: "/"
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
        volumeMounts:
        - name: device-plugin
          mountPath: /var/lib/kubelet/device-plugins
        - name: dev
          mountPath: /dev
        - name: nvidia-driver
          mountPath: /usr/local/nvidia
          readOnly: true
        - name: proc-driver
          mountPath: /proc/driver/nvidia
          readOnly: true
        resources:
          requests:
            cpu: 50m
            memory: 50Mi
          limits:
            cpu: 100m
            memory: 100Mi
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 15
      volumes:
      - name: device-plugin
        hostPath:
          path: /var/lib/kubelet/device-plugins
      - name: dev
        hostPath:
          path: /dev
      - name: nvidia-driver
        hostPath:
          path: /usr/local/nvidia
      - name: proc-driver
        hostPath:
          path: /proc/driver/nvidia
      - name: host-tmp
        hostPath:
          path: /tmp
      nodeSelector:
        kubernetes.io/hostname: yeezyai
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nvidia-device-plugin
  namespace: nvidia-device-plugin
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nvidia-device-plugin
rules:
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: nvidia-device-plugin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nvidia-device-plugin
subjects:
- kind: ServiceAccount
  name: nvidia-device-plugin
  namespace: nvidia-device-plugin
---
