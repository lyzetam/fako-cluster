# infrastructure/controllers/base/nvidia-toolkit-fixed/nvidia-toolkit-installer.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: nvidia-toolkit-installer
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nvidia-toolkit-installer-script
  namespace: nvidia-toolkit-installer
data:
  install.sh: |
    #!/bin/bash
    set -e
    
    echo "Starting NVIDIA Container Toolkit Installation..."
    echo "Date: $(date)"
    echo "Hostname: $(hostname)"
    
    # Check if already installed
    if command -v nvidia-ctk >/dev/null 2>&1; then
        echo "NVIDIA Container Toolkit already installed"
        echo "Version: $(nvidia-ctk --version)"
        echo "Keeping container alive..."
        sleep infinity
        exit 0
    fi
    
    # Install dependencies
    apt-get update
    apt-get install -y curl gnupg2 software-properties-common
    
    # Remove any broken repository files
    rm -f /etc/apt/sources.list.d/nvidia-container-toolkit.list
    rm -f /etc/apt/sources.list.d/libnvidia-container.list
    
    # Use the official NVIDIA installation method
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
        gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    
    curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
        sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
        tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
    
    # Update and install with specific version
    apt-get update
    
    NVIDIA_CONTAINER_TOOLKIT_VERSION=1.17.8-1
    apt-get install -y \
        nvidia-container-toolkit=${NVIDIA_CONTAINER_TOOLKIT_VERSION} \
        nvidia-container-toolkit-base=${NVIDIA_CONTAINER_TOOLKIT_VERSION} \
        libnvidia-container-tools=${NVIDIA_CONTAINER_TOOLKIT_VERSION} \
        libnvidia-container1=${NVIDIA_CONTAINER_TOOLKIT_VERSION}
    
    # Configure runtime
    nvidia-ctk runtime configure --runtime=containerd --config=/host/etc/containerd/config.toml
    
    # Copy binaries to host
    mkdir -p /host/usr/bin
    cp -f /usr/bin/nvidia-ctk /host/usr/bin/ || true
    cp -f /usr/bin/nvidia-container-* /host/usr/bin/ || true
    
    echo "NVIDIA Container Toolkit installation completed!"
    echo "Version: $(nvidia-ctk --version)"
    
    # Signal to restart containerd on host
    touch /host/tmp/restart-containerd
    
    echo "Keeping container alive..."
    sleep infinity
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nvidia-toolkit-installer
  namespace: nvidia-toolkit-installer
spec:
  selector:
    matchLabels:
      name: nvidia-toolkit-installer
  template:
    metadata:
      labels:
        name: nvidia-toolkit-installer
    spec:
      nodeSelector:
        kubernetes.io/hostname: yeezyai
      hostNetwork: true
      hostPID: true
      containers:
      - name: installer
        image: ubuntu:24.04
        command: ["/bin/bash", "/scripts/install.sh"]
        securityContext:
          privileged: true
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        - name: host-usr
          mountPath: /host/usr
        - name: host-etc
          mountPath: /host/etc
        - name: host-tmp
          mountPath: /host/tmp
        env:
        - name: DEBIAN_FRONTEND
          value: "noninteractive"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: scripts
        configMap:
          name: nvidia-toolkit-installer-script
          defaultMode: 0755
      - name: host-usr
        hostPath:
          path: /usr
      - name: host-etc
        hostPath:
          path: /etc
      - name: host-tmp
        hostPath:
          path: /tmp