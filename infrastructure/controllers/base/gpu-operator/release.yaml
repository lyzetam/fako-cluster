# infrastructure/controllers/base/gpu-operator/release.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gpu-operator
  namespace: gpu-operator
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: gpu-operator
      version: "v25.3.1"
      sourceRef:
        kind: HelmRepository
        name: nvidia
        namespace: gpu-operator
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  values:
    # CRITICAL: Since drivers are pre-installed, disable ALL driver management
    driver:
      enabled: false
    
    # Disable toolkit since it's having issues with symlinks
    toolkit:
      enabled: false
    
    # Only enable the device plugin - this is what exposes GPUs to K8s
    devicePlugin:
      enabled: true
      config:
        name: default-config
    
    # Disable all other components
    nfd:
      enabled: false
    gfd:
      enabled: false
    dcgm:
      enabled: false
    dcgmExporter:
      enabled: false
    migManager:
      enabled: false
    validator:
      enabled: false
    
    # Runtime configuration
    operator:
      defaultRuntime: containerd
    
    # Ensure device plugin runs on GPU nodes
    daemonsets:
      updateStrategy: "RollingUpdate"
      priorityClassName: system-node-critical
      tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule



# # infrastructure/controllers/base/gpu-operator/release.yaml
# apiVersion: helm.toolkit.fluxcd.io/v2
# kind: HelmRelease
# metadata:
#   name: gpu-operator
#   namespace: gpu-operator
# spec:
#   interval: 30m
#   timeout: 10m
#   chart:
#     spec:
#       chart: gpu-operator
#       version: "v25.3.1"  #
#       sourceRef:
#         kind: HelmRepository
#         name: nvidia
#         namespace: gpu-operator
#   install:
#     crds: CreateReplace
#     remediation:
#       retries: 3
#   upgrade:
#     crds: CreateReplace
#     remediation:
#       retries: 3
#   values:
#     # Since drivers are already installed on yeezyai, disable driver container
#     driver:
#       enabled: false
      
#     # Container toolkit configuration
#     toolkit:
#       enabled: true
#       version: v1.16.2
      
#     # Device plugin configuration
#     devicePlugin:
#       enabled: true
#       config:
#         name: default-config
      
#     # Optional components
#     nfd:
#       enabled: false  # Disable if you don't need node feature discovery
      
#     gfd:
#       enabled: true  # GPU Feature Discovery
      
#     dcgm:
#       enabled: false
      
#     dcgmExporter:
#       enabled: false
      
#     migManager:
#       enabled: false
      
#     # Validator configuration
#     validator:
#       enabled: false  # Disable validator for now
          
#     # Operator configuration
#     operator:
#       defaultRuntime: containerd
      
#     # Daemonsets configuration
#     daemonsets:
#       updateStrategy: "RollingUpdate"
#       priorityClassName: system-node-critical
#       tolerations:
#       - key: nvidia.com/gpu
#         operator: Exists
#         effect: NoSchedule