# apps/base/gpu-diagnostics/job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: gpu-node-diagnostics
  namespace: gpu-diagnostics
spec:
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour
  template:
    spec:
      serviceAccountName: gpu-diagnostics
      restartPolicy: Never
      nodeSelector:
        kubernetes.io/hostname: playground  # Fixed to match actual node name
      containers:
      - name: diagnostics
        image: busybox:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "=== GPU Node Diagnostics Report ==="
          echo "Date: $(date)"
          echo ""
          
          echo "=== Node Information ==="
          echo "Hostname: $(hostname)"
          echo "Kernel: $(uname -r)"
          echo ""
          
          echo "=== CPU Information ==="
          cat /proc/cpuinfo | grep -E "model name|processor" | head -8
          echo ""
          
          echo "=== Memory Information ==="
          free -h
          echo ""
          
          echo "=== GPU/DRI Device Check ==="
          if [ -d /dev/dri ]; then
            echo "DRI devices found:"
            ls -la /dev/dri/
          else
            echo "ERROR: No DRI devices found!"
          fi
          echo ""
          
          echo "=== PCI Devices (VGA/Display) ==="
          cat /sys/bus/pci/devices/*/class | while read class; do
            if [[ "$class" == "0x030000" ]] || [[ "$class" == "0x038000" ]]; then
              device_path=$(dirname $(grep -l "$class" /sys/bus/pci/devices/*/class))
              echo "Found display device at: $device_path"
              [ -f "$device_path/vendor" ] && echo "  Vendor: $(cat $device_path/vendor)"
              [ -f "$device_path/device" ] && echo "  Device: $(cat $device_path/device)"
            fi
          done
          echo ""
          
          echo "=== Checking for AMD GPU ==="
          if grep -q "AMD" /proc/cpuinfo; then
            echo "AMD processor detected"
          fi
          
          echo ""
          echo "=== Mount Points ==="
          mount | grep -E "(dri|gpu|render)"
          
          echo ""
          echo "=== Diagnostics Complete ==="
        volumeMounts:
        - name: dri-devices
          mountPath: /dev/dri
          readOnly: true
        - name: sys
          mountPath: /sys
          readOnly: true
      volumes:
      - name: dri-devices
        hostPath:
          path: /dev/dri
          type: Directory
      - name: sys
        hostPath:
          path: /sys
          type: Directory