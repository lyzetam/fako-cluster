apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: backstage
  namespace: backstage
spec:
  interval: 30m
  chart:
    spec:
      chart: backstage
      version: "5.x"
      sourceRef:
        kind: HelmRepository
        name: rhdh-chart
        namespace: backstage
  values:
    # Global RHDH configuration
    global:
      host: backstage.landryzetam.net
      dynamic:
        includes:
          - "dynamic-plugins.default.yaml"
        plugins: []

    # Upstream Backstage configuration
    upstream:
      backstage:
        image:
          registry: quay.io
          repository: rhdh-community/rhdh
          tag: "next"

        # Mount app-config from ConfigMap
        extraAppConfig:
          - filename: app-config.yaml
            configMapRef: backstage-app-config

        # Environment variables from secrets
        extraEnvVarsSecrets:
          - backstage-postgres-secret
          - backstage-keycloak-secret

        # Additional environment variables
        extraEnvVars:
          - name: NODE_OPTIONS
            value: "--max-old-space-size=4096"

        # Resource limits
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2"

      # Disable built-in PostgreSQL (using CloudNative-PG)
      postgresql:
        enabled: false

      # Ingress handled separately by our ingress.yaml
      ingress:
        enabled: false

      # Service configuration
      service:
        type: ClusterIP
        ports:
          backend: 7007
