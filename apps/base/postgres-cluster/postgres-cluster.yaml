apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres-cluster
  namespace: postgres
spec:
  instances: 3
  imageName: ghcr.io/cloudnative-pg/postgresql:16.2
  enableSuperuserAccess: true
  
  primaryUpdateStrategy: unsupervised
  startDelay: 300
  stopDelay: 300
  
  # Single postgresql section with all configurations merged
  postgresql:
    parameters:
      max_connections: "200"
      shared_buffers: "256MB"
      effective_cache_size: "1GB"
      work_mem: "4MB"
      maintenance_work_mem: "64MB"
      wal_level: "replica"
      max_wal_size: "1GB"
      min_wal_size: "80MB"
      checkpoint_timeout: "5min"
      checkpoint_completion_target: "0.9"
      # Add shared_preload_libraries here
      shared_preload_libraries: "pg_stat_statements"
    
    pg_hba:
      - host all all 10.0.0.0/8 md5
      - host all all 172.16.0.0/12 md5
      - host all all 192.168.0.0/16 md5
  
  bootstrap:
    initdb:
      database: app
      owner: app
      secret:
        name: app-user-secret
      dataChecksums: true
      encoding: "UTF8"
      localeCollate: "en_US.UTF-8"
      localeCType: "en_US.UTF-8"
  
  storage:
    size: 50Gi
    storageClass: "nfs-postgres"
  
  resources:
    requests:
      memory: "2Gi"
      cpu: "1"
    limits:
      memory: "4Gi"
      cpu: "2"
  
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
  
  monitoring:
    customQueriesConfigMap:
      - name: postgres-monitoring
        key: custom-queries
  