apiVersion: apps/v1
kind: Deployment
metadata:
  name: family-manager-bot
  namespace: family-manager
  labels:
    app: family-manager-bot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: family-manager-bot
  template:
    metadata:
      labels:
        app: family-manager-bot
    spec:
      imagePullSecrets:
        - name: dockerhub-secret
      containers:
        - name: bot
          image: lzetam/family-manager-bot:latest
          command: ["python", "bot.py"]
          env:
            - name: MEMORY_BACKEND
              value: "supabase"
          envFrom:
            - secretRef:
                name: family-manager-secrets
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          volumeMounts:
            - name: data
              mountPath: /app/data
          startupProbe:
            exec:
              command:
                - python
                - -c
                - |
                  import asyncio
                  from services.health_check import check_readiness
                  status = asyncio.run(check_readiness())
                  exit(0 if status.status == 'healthy' else 1)
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 30
            failureThreshold: 30
          livenessProbe:
            exec:
              command:
                - pgrep
                - -f
                - "python bot.py"
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        - name: data
          emptyDir: {}
