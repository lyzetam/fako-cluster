apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubescape-operator
  namespace: kubescape
spec:
  interval: 30m
  chart:
    spec:
      chart: kubescape-operator
      version: "1.x"
      sourceRef:
        kind: HelmRepository
        name: kubescape
        namespace: kubescape
  # Use postRenderers to patch the kubevuln deployment
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              name: kubevuln
            patch: |
              - op: replace
                path: /spec/template/spec/containers/0/readinessProbe
                value:
                  httpGet:
                    path: /v1/readiness
                    port: 8080
                  initialDelaySeconds: 60
                  timeoutSeconds: 10
                  periodSeconds: 10
                  failureThreshold: 3
              - op: replace
                path: /spec/template/spec/containers/0/livenessProbe
                value:
                  httpGet:
                    path: /v1/liveness
                    port: 8080
                  initialDelaySeconds: 90
                  timeoutSeconds: 10
                  periodSeconds: 30
                  failureThreshold: 3
  values:
    # Enable continuous scanning for real-time monitoring
    capabilities:
      continuousScan: enable
      networkPolicyService: enable
      
    # Configure storage for scan results
    storage:
      enabled: true
      storageClass: nfs-security-logs  # Use our dedicated security logs storage
      size: 20Gi
      
    # Configure persistent storage for vulnerability database
    vulnerabilityDB:
      persistence:
        enabled: true
        storageClass: nfs-security-logs
        size: 10Gi
        accessMode: ReadWriteOnce
        
    # Configure the Kubescape cloud component (optional - for cloud dashboard)
    kubescapeCloud:
      enabled: false  # Set to true if you have a Kubescape cloud account
      
    # Configure scanning intervals
    scanSchedule:
      frameworks:
        - name: "nsa"
          cronTabSchedule: "0 */6 * * *"  # Every 6 hours
        - name: "mitre"
          cronTabSchedule: "0 */6 * * *"
        - name: "cis-v1.23-t1.0.1"
          cronTabSchedule: "0 2 * * *"    # Daily at 2 AM
          
    # Network policy configuration
    networkPolicy:
      enabled: true
      scanInterval: 15m
      
    # Resource requests and limits
    operator:
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
          ephemeral-storage: "1Gi"
        limits:
          memory: "512Mi"
          cpu: "500m"
          ephemeral-storage: "2Gi"
          
    kubevuln:
      resources:
        requests:
          memory: "512Mi"
          cpu: "200m"
          ephemeral-storage: "5Gi"
        limits:
          memory: "1Gi"
          cpu: "500m"
          ephemeral-storage: "15Gi"  # Significantly increased to prevent eviction
      # Configure readiness probe with longer timeout
      readinessProbe:
        httpGet:
          path: /v1/readiness
          port: 8080
        initialDelaySeconds: 60    # Give time for grype DB update
        timeoutSeconds: 10         # Increase from default 1s to 10s
        periodSeconds: 10
        failureThreshold: 3
      # Configure liveness probe similarly
      livenessProbe:
        httpGet:
          path: /v1/liveness
          port: 8080
        initialDelaySeconds: 90    # Start after readiness probe
        timeoutSeconds: 10
        periodSeconds: 30
        failureThreshold: 3
          
    gateway:
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
          ephemeral-storage: "1Gi"
        limits:
          memory: "512Mi"
          cpu: "300m"
          ephemeral-storage: "2Gi"
          
    # Enable prometheus metrics
    prometheus:
      enabled: true
      
    # Node agent configuration
    nodeAgent:
      # Only deploy on Linux nodes (BTF support required)
      nodeSelector:
        kubernetes.io/os: linux
      # Skip nodes without proper kernel support
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values:
                - linux
              - key: kubernetes.io/hostname
                operator: NotIn
                values:
                - zz-macbookpro  # Exclude macOS node
