apiVersion: v1
kind: ConfigMap
metadata:
  name: zi-agent-generators
  namespace: zi
  labels:
    app.kubernetes.io/name: zi
    app.kubernetes.io/component: generators
    app.kubernetes.io/part-of: claude-agent-platform
data:
  generate-manifests.py: |
    #!/usr/bin/env python3
    """Generate K8s deployment and service manifests for all zI agents.

    NOTE: AGENT_TOOLS is NOT defined here - it's defined in each agent's Dockerfile
    to maintain a single source of truth. Only AGENT_NAME, AGENT_DESCRIPTION, and
    AGENT_MAX_ITERATIONS are set in K8s manifests.

    Run from: apps/base/zi/
    """

    from pathlib import Path

    # Agent configurations: slug -> (description, max_iterations, resource_tier)
    # 63 agents aligned with zi registry (Feb 2026)
    AGENTS = {
        "account-executive": ("Full-cycle sales, discovery calls, product demonstrations, and deal closing", 15, "standard"),
        "ai-engineer": ("AI/ML integration, LLM applications, AI architecture, and ML systems", 15, "standard"),
        "ap-specialist": ("Accounts payable, vendor payments, expense processing, and payment operations", 15, "standard"),
        "app-security": ("Application security, vulnerability management, secure code review, and OWASP compliance", 15, "standard"),
        "app-sre": ("Application reliability, monitoring, incident response, and performance optimization", 15, "standard"),
        "ar-manager": ("Accounts receivable, collections, cash application, and DSO optimization", 15, "standard"),
        "backend-engineer": ("Backend development, API design, database optimization, and service implementation", 15, "standard"),
        "business-development-rep": ("Outbound prospecting, cold calling, and new business generation", 15, "standard"),
        "business-operations-manager": ("Process optimization, OKR management, strategic initiatives, and operational efficiency", 15, "standard"),
        "cloud-engineer": ("AWS infrastructure, cloud architecture, cost optimization, and cloud operations", 15, "standard"),
        "code-reviewer": ("Code review, code quality, best practices, and technical feedback", 15, "complex"),
        "communications-director": ("Corporate communications, PR strategy, crisis management, and external messaging", 15, "standard"),
        "competitive-analyst": ("Competitive intelligence, feature tracking, pricing analysis, win/loss patterns, and market threat assessment", 15, "standard"),
        "content-manager": ("Content strategy, editorial calendar, content creation, and distribution", 15, "standard"),
        "controller": ("Accounting operations, financial controls, month-end close, and compliance", 15, "standard"),
        "creative-director": ("Brand creative direction, visual identity, design leadership, and creative excellence", 15, "standard"),
        "cs-director": ("Customer success leadership, retention strategy, team management, and account planning", 15, "standard"),
        "cs-operations-analyst": ("Customer health scoring, analytics, reporting, and operational excellence", 15, "standard"),
        "customer-education-manager": ("Customer training programs, certification development, and education strategy", 15, "standard"),
        "customer-success-manager": ("Customer health management, adoption driving, renewal management, and upsell identification", 15, "standard"),
        "data-engineer": ("Data pipelines, ETL, data warehousing, and analytics infrastructure", 15, "standard"),
        "debugger": ("Systematic bug hunting, error analysis, and root cause investigation", 20, "complex"),
        "devops-engineer": ("CI/CD, infrastructure automation, deployment pipelines, and operational excellence", 15, "standard"),
        "digital-marketing-manager": ("Paid media, SEO, SEM, web optimization, and digital channel management", 15, "standard"),
        "financial-analyst": ("Financial analysis, reporting, modeling, and business intelligence", 15, "standard"),
        "fpa-manager": ("Financial planning, budgeting, forecasting, and variance analysis", 15, "standard"),
        "frontend-engineer": ("Frontend development, UI implementation, performance optimization, and accessibility", 15, "standard"),
        "governance-engine": ("Spending policy enforcement, budget management, and approval workflows", 15, "standard"),
        "head-of-design": ("Design leadership, UX strategy, design systems, and team management", 15, "standard"),
        "hr-manager": ("People operations, talent management, culture building, and HR programs", 15, "standard"),
        "k8s-engineer": ("Kubernetes deployment, cluster management, container orchestration, and cloud native architecture", 15, "standard"),
        "legal-counsel": ("Contract management, compliance, legal risk mitigation, and corporate governance", 15, "standard"),
        "market-researcher": ("Market intelligence, industry trends, emerging tech, startup scouting, and partnership/regulatory opportunity identification", 15, "standard"),
        "marketing-operations-manager": ("Marketing technology, data management, automation, and operational excellence", 15, "standard"),
        "onboarding-manager": ("Customer onboarding, implementation management, and time-to-value optimization", 15, "standard"),
        "platform-security": ("Platform security, infrastructure hardening, compliance, and security operations", 15, "standard"),
        "platform-sre": ("Platform reliability, infrastructure operations, and SRE practices", 15, "standard"),
        "pr-manager": ("Media relations, press releases, analyst relations, and public relations", 15, "standard"),
        "procurement-manager": ("Vendor selection, contract negotiation, purchasing, and supplier management", 15, "standard"),
        "product-manager": ("Feature definition, user stories, roadmap execution, and product delivery", 15, "standard"),
        "product-marketing-manager": ("Product launches, sales enablement, competitive positioning, and market messaging", 15, "standard"),
        "product-operations-manager": ("Product process optimization, feedback management, and product analytics", 15, "standard"),
        "project-manager": ("Cross-functional project coordination, timeline management, and delivery excellence", 15, "standard"),
        "qa-engineer": ("Quality assurance, test automation, verification, and quality engineering", 15, "standard"),
        "recruiter": ("Talent acquisition, candidate pipeline management, and hiring excellence", 15, "standard"),
        "sales-development-rep": ("Lead qualification, meeting generation, outbound prospecting, and pipeline building", 15, "standard"),
        "sales-enablement-manager": ("Sales training, content creation, playbooks, and onboarding programs", 15, "standard"),
        "sales-manager": ("Sales team coaching, deal strategy, pipeline management, and quota attainment", 15, "standard"),
        "sales-operations-analyst": ("CRM management, sales reporting, data analysis, and process automation", 15, "standard"),
        "sdr-manager": ("SDR team leadership, outbound strategy, and lead generation management", 15, "standard"),
        "security-engineer": ("Org-wide security, threat detection, security architecture, and security operations", 15, "standard"),
        "senior-product-manager": ("Complex feature ownership, product strategy, and cross-functional leadership", 15, "standard"),
        "social-media-manager": ("Social strategy, community management, content scheduling, and social engagement", 15, "standard"),
        "solutions-architect": ("Architecture design, scalability planning, and technical leadership", 15, "complex"),
        "support-manager": ("Support operations, SLA management, ticket routing, and CSAT optimization", 15, "standard"),
        "support-representative": ("Ticket resolution, customer support, troubleshooting, and help desk operations", 15, "standard"),
        "tdd-engineer": ("Test-driven development, red-green-refactor cycles, and testable design", 15, "standard"),
        "tech-lead": ("Technical decisions, team leadership, code quality, and delivery management", 15, "complex"),
        "tech-writer": ("Technical documentation, API docs, developer guides, and knowledge base management", 15, "standard"),
        "technical-product-manager": ("API/platform product management, technical specifications, and developer experience", 15, "standard"),
        "technical-support-specialist": ("Complex troubleshooting, technical escalations, and advanced support", 15, "standard"),
        "ux-designer": ("UI/UX design, visual design, prototyping, design systems, and interaction excellence", 15, "standard"),
        "ux-researcher": ("User research, usability testing, customer insights, and research synthesis", 15, "standard"),
    }

    RESOURCE_TIERS = {
        "standard": {
            "requests_cpu": "100m",
            "requests_memory": "256Mi",
            "limits_cpu": "500m",
            "limits_memory": "1Gi",
        },
        "complex": {
            "requests_cpu": "250m",
            "requests_memory": "512Mi",
            "limits_cpu": "1",
            "limits_memory": "2Gi",
        },
    }


    def generate_deployment(slug, description, max_iter, tier):
        resources = RESOURCE_TIERS[tier]
        return f'''apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: agent-{slug}
      namespace: zi
      labels:
        app.kubernetes.io/name: agent-{slug}
        app.kubernetes.io/component: agent
        app.kubernetes.io/part-of: zi
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: agent-{slug}
      template:
        metadata:
          labels:
            app: agent-{slug}
            app.kubernetes.io/name: agent-{slug}
            app.kubernetes.io/component: agent
        spec:
          imagePullSecrets:
            - name: dockerhub-registry
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
            - name: agent
              image: lzetam/zi-agent-{slug}:latest
              imagePullPolicy: Always
              ports:
                - containerPort: 8000
                  name: http
              env:
                - name: AGENT_NAME
                  value: "{slug}"
                - name: AGENT_DESCRIPTION
                  value: "{description}"
                - name: AGENT_MAX_ITERATIONS
                  value: "{max_iter}"
                - name: ZI_BRAIN_URL
                  value: "http://zi-brain.zi.svc.cluster.local:8100"
                - name: ZI_OLLAMA_URL
                  value: "http://ollama-gpu.ollama.svc.cluster.local:11434"
                - name: ZI_KNOWLEDGE_REDIS_HOST
                  value: "redis.zi.svc.cluster.local"
                - name: ZI_KNOWLEDGE_REDIS_PORT
                  value: "6379"
                - name: ZI_API_URL
                  value: "http://zi.zi.svc.cluster.local:8080"
              envFrom:
                - secretRef:
                    name: zi-secrets
              volumeMounts:
                - name: agent-memory
                  mountPath: /data
                  subPath: {slug}
              resources:
                requests:
                  cpu: {resources["requests_cpu"]}
                  memory: {resources["requests_memory"]}
                limits:
                  cpu: {resources["limits_cpu"]}
                  memory: {resources["limits_memory"]}
              livenessProbe:
                httpGet:
                  path: /health
                  port: http
                initialDelaySeconds: 10
                periodSeconds: 30
              readinessProbe:
                httpGet:
                  path: /ready
                  port: http
                initialDelaySeconds: 5
                periodSeconds: 10
          volumes:
            - name: agent-memory
              persistentVolumeClaim:
                claimName: zi-agents-memory
    '''


    def generate_service(slug):
        return f'''apiVersion: v1
    kind: Service
    metadata:
      name: agent-{slug}
      namespace: zi
      labels:
        app.kubernetes.io/name: agent-{slug}
        app.kubernetes.io/component: agent
        app.kubernetes.io/part-of: zi
    spec:
      selector:
        app: agent-{slug}
      ports:
        - port: 8000
          targetPort: http
          name: http
    '''


    def main():
        script_dir = Path(__file__).parent
        deployments_dir = script_dir / "deployments"
        services_dir = script_dir / "services"
        deployments_dir.mkdir(exist_ok=True)
        services_dir.mkdir(exist_ok=True)

        print("Generating K8s manifests for zi agents...")
        for slug, (description, max_iter, tier) in AGENTS.items():
            deployment = generate_deployment(slug, description, max_iter, tier)
            (deployments_dir / f"{slug}.yaml").write_text(deployment)
            service = generate_service(slug)
            (services_dir / f"{slug}.yaml").write_text(service)
            print(f"  Generated: {slug} (tier: {tier})")

        print(f"\nGenerated {len(AGENTS)} deployment and service manifests.")


    if __name__ == "__main__":
        main()

  generate-manifests-full.py: |
    #!/usr/bin/env python3
    """Generate K8s deployment and service manifests for ALL zI agents.

    Run from: apps/base/zi/
    Requires: ~/dev/zi/agents/registry.yaml
    """

    import yaml
    from pathlib import Path

    ZI_AGENTS_DIR = Path.home() / "dev/zi/agents"
    registry_path = ZI_AGENTS_DIR / "registry.yaml"

    if not registry_path.exists():
        print(f"ERROR: Registry not found at {registry_path}")
        exit(1)

    with open(registry_path) as f:
        registry = yaml.safe_load(f)

    RESOURCE_TIERS = {
        "standard": {"requests_cpu": "5m", "requests_memory": "32Mi", "limits_cpu": "100m", "limits_memory": "256Mi"},
        "complex": {"requests_cpu": "5m", "requests_memory": "32Mi", "limits_cpu": "100m", "limits_memory": "256Mi"},
        "executive": {"requests_cpu": "5m", "requests_memory": "32Mi", "limits_cpu": "100m", "limits_memory": "256Mi"},
    }


    def generate_deployment(slug, description, tier="standard"):
        resources = RESOURCE_TIERS[tier]
        s = slug.replace("_", "-")
        return f'''apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: agent-{s}
      namespace: zi
      labels:
        app.kubernetes.io/name: agent-{s}
        app.kubernetes.io/component: agent
        app.kubernetes.io/part-of: zi
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: agent-{s}
      template:
        metadata:
          labels:
            app: agent-{s}
            app.kubernetes.io/name: agent-{s}
            app.kubernetes.io/component: agent
        spec:
          imagePullSecrets:
            - name: dockerhub-registry
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
            - name: agent
              image: lzetam/zi-agent-{s}:latest
              imagePullPolicy: Always
              ports:
                - containerPort: 8000
                  name: http
              env:
                - name: AGENT_NAME
                  value: "{s}"
                - name: AGENT_DESCRIPTION
                  value: "{description}"
                - name: AGENT_MAX_ITERATIONS
                  value: "15"
                - name: ZI_BRAIN_URL
                  value: "http://zi-brain.zi.svc.cluster.local:8100"
                - name: ZI_OLLAMA_URL
                  value: "http://ollama-gpu.ollama.svc.cluster.local:11434"
                - name: ZI_KNOWLEDGE_REDIS_HOST
                  value: "redis.zi.svc.cluster.local"
                - name: ZI_KNOWLEDGE_REDIS_PORT
                  value: "6379"
                - name: ZI_API_URL
                  value: "http://zi.zi.svc.cluster.local:8080"
              envFrom:
                - secretRef:
                    name: zi-secrets
              volumeMounts:
                - name: agent-memory
                  mountPath: /data
                  subPath: {s}
              resources:
                requests:
                  cpu: {resources["requests_cpu"]}
                  memory: {resources["requests_memory"]}
                limits:
                  cpu: {resources["limits_cpu"]}
                  memory: {resources["limits_memory"]}
              livenessProbe:
                httpGet:
                  path: /health
                  port: http
                initialDelaySeconds: 10
                periodSeconds: 30
              readinessProbe:
                httpGet:
                  path: /ready
                  port: http
                initialDelaySeconds: 5
                periodSeconds: 10
          volumes:
            - name: agent-memory
              persistentVolumeClaim:
                claimName: zi-agents-memory
    '''


    def generate_service(slug):
        s = slug.replace("_", "-")
        return f'''apiVersion: v1
    kind: Service
    metadata:
      name: agent-{s}
      namespace: zi
      labels:
        app.kubernetes.io/name: agent-{s}
        app.kubernetes.io/component: agent
        app.kubernetes.io/part-of: zi
    spec:
      selector:
        app: agent-{s}
      ports:
        - port: 8000
          targetPort: http
          name: http
    '''


    def main():
        script_dir = Path(__file__).parent
        deployments_dir = script_dir / "deployments"
        services_dir = script_dir / "services"
        deployments_dir.mkdir(exist_ok=True)
        services_dir.mkdir(exist_ok=True)

        generated = 0
        skipped = 0
        for slug, info in registry["agents"].items():
            description = info.get("description", "")
            team = info.get("team", "")
            tier = "executive" if team == "Executive" else ("complex" if slug in ["code-reviewer","debugger","solutions-architect","tech-lead"] else "standard")
            s = slug.replace("_", "-")
            agent_dir = ZI_AGENTS_DIR / slug
            if not agent_dir.exists() or not (agent_dir / "Dockerfile").exists():
                skipped += 1
                continue
            (deployments_dir / f"{s}.yaml").write_text(generate_deployment(slug, description, tier))
            (services_dir / f"{s}.yaml").write_text(generate_service(slug))
            generated += 1

        print(f"Generated {generated}, skipped {skipped}")


    if __name__ == "__main__":
        main()

  force-restart.py: |
    #!/usr/bin/env python3
    """Add a restart annotation to all agent deployments to force new replicasets.

    Run from: apps/base/zi/
    """

    from pathlib import Path
    from datetime import datetime
    import re

    def add_restart_annotation(manifest_path):
        content = manifest_path.read_text()
        timestamp = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")
        if "kubectl.kubernetes.io/restartedAt" in content:
            content = re.sub(
                r'kubectl\.kubernetes\.io/restartedAt: ".*?"',
                f'kubectl.kubernetes.io/restartedAt: "{timestamp}"',
                content
            )
        else:
            pattern = r'(  template:\n    metadata:\n      labels:\n(?:        .*\n)*)'
            def add_annotation(match):
                return f'{match.group(1)}      annotations:\n        kubectl.kubernetes.io/restartedAt: "{timestamp}"\n'
            content = re.sub(pattern, add_annotation, content)
        manifest_path.write_text(content)
        print(f"Updated {manifest_path.name}")

    def main():
        deployments_dir = Path(__file__).parent / "deployments"
        count = 0
        for manifest in sorted(deployments_dir.glob("*.yaml")):
            add_restart_annotation(manifest)
            count += 1
        print(f"\nUpdated {count} deployment manifests")

    if __name__ == "__main__":
        main()

  update-kustomization.sh: |
    #!/bin/bash
    # Update kustomization.yaml with all deployment and service manifests
    # Run from: apps/base/zi/
    set -e
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    DEPLOYMENTS=($(ls -1 "${SCRIPT_DIR}/deployments/"*.yaml | sort | xargs -n1 basename))
    SERVICES=($(ls -1 "${SCRIPT_DIR}/services/"*.yaml | sort | xargs -n1 basename))
    echo "Found ${#DEPLOYMENTS[@]} deployments and ${#SERVICES[@]} services"
    echo ""
    echo "# Agent deployments"
    for d in "${DEPLOYMENTS[@]}"; do echo "  - deployments/${d}"; done
    echo ""
    echo "# Agent services"
    for s in "${SERVICES[@]}"; do echo "  - services/${s}"; done

  update-resources.sh: |
    #!/bin/bash
    # Update all agent deployments to use minimal resources
    # Run from: apps/base/zi/
    for file in deployments/*.yaml; do
      sed -i '' '
        s/cpu: 100m/cpu: 25m/g
        s/cpu: 200m/cpu: 50m/g
        s/cpu: 250m/cpu: 50m/g
        s/cpu: 500m/cpu: 200m/g
        s/cpu: 750m/cpu: 300m/g
        s/cpu: "1"/cpu: 500m/g
        s/memory: 256Mi/memory: 128Mi/g
        s/memory: 512Mi/memory: 256Mi/g
        s/memory: 1Gi/memory: 512Mi/g
        s/memory: 1.5Gi/memory: 768Mi/g
        s/memory: 2Gi/memory: 1Gi/g
      ' "$file"
    done
    echo "Updated resource allocations in all deployments"
