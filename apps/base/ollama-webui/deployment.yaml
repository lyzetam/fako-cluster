apiVersion: apps/v1
kind: Deployment
metadata:
  name: ollama-webui
  namespace: ollama-webui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ollama-webui
  template:
    metadata:
      labels:
        app: ollama-webui
    spec:
      initContainers:
      - name: config-injector
        image: busybox:latest
        command: ['sh', '-c']
        args:
        - |
          # Get GPUStack config from secret
          GPUSTACK_URL=$(cat /secrets/gpustack/api-base-url)
          GPUSTACK_KEY=$(cat /secrets/gpustack/api-key)
          
          # Create environment file
          cat > /config/env-config <<EOF
          OPENAI_API_BASE_URL=$GPUSTACK_URL
          OPENAI_API_KEY=$GPUSTACK_KEY
          OPENAI_API_BASE_URLS=$GPUSTACK_URL
          OPENAI_API_KEYS=$GPUSTACK_KEY
          EOF
        volumeMounts:
        - name: gpustack-secret
          mountPath: /secrets/gpustack
        - name: config-volume
          mountPath: /config
      
      containers:
      - name: ollama-webui
        image: ghcr.io/open-webui/open-webui:latest
        ports:
        - containerPort: 8080
          protocol: TCP
        envFrom:
        - configMapRef:
            name: ollama-webui-configmap
        env:
        # Override with values from secret
        - name: OPENAI_API_BASE_URL
          valueFrom:
            secretKeyRef:
              name: gpustack-config
              key: api-base-url
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: gpustack-config
              key: api-key
        - name: OPENAI_API_BASE_URLS
          valueFrom:
            secretKeyRef:
              name: gpustack-config
              key: api-base-url
        - name: OPENAI_API_KEYS
          valueFrom:
            secretKeyRef:
              name: gpustack-config
              key: api-key
        volumeMounts:
        - mountPath: /app/backend/data
          name: webui-data
        resources:
          requests:
            memory: "3Gi"
            cpu: "1500m"
          limits:
            memory: "6Gi"
            cpu: "3000m"
      
      volumes:
      - name: webui-data
        persistentVolumeClaim:
          claimName: ollama-webui-data
      - name: gpustack-secret
        secret:
          secretName: gpustack-config
      - name: config-volume
        emptyDir: {}




# # apps/base/ollama-webui/deployment.yaml
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: ollama-webui
#   namespace: ollama-webui
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: ollama-webui
#   template:
#     metadata:
#       labels:
#         app: ollama-webui
#     spec:
#       securityContext:
#         fsGroup: 0
#         runAsUser: 0
#         runAsGroup: 0
#       containers:
#         - name: ollama-webui
#           image: ghcr.io/open-webui/open-webui:latest
#           ports:
#             - containerPort: 8080
#               protocol: TCP
#           envFrom:
#             - configMapRef:
#                 name: ollama-webui-configmap  # This loads ALL configmap values
#           # REMOVED the hardcoded env section that was overriding the configmap!
#           volumeMounts:
#             - mountPath: /app/backend/data
#               name: webui-data
#           resources:
#             requests:
#               memory: "3Gi"
#               cpu: "1500m"
#             limits:
#               memory: "6Gi"
#               cpu: "3000m"
#           livenessProbe:
#             httpGet:
#               path: /
#               port: 8080
#             initialDelaySeconds: 30
#             periodSeconds: 30
#             timeoutSeconds: 10
#           readinessProbe:
#             httpGet:
#               path: /
#               port: 8080
#             initialDelaySeconds: 15
#             periodSeconds: 10
#             timeoutSeconds: 5
#           startupProbe:
#             httpGet:
#               path: /
#               port: 8080
#             initialDelaySeconds: 15
#             periodSeconds: 5
#             timeoutSeconds: 3
#             failureThreshold: 12
#       volumes:
#         - name: webui-data
#           persistentVolumeClaim:
#             claimName: ollama-webui-data
