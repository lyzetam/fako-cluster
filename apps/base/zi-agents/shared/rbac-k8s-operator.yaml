# RBAC for k8s-engineer and platform-sre agents
# These agents need kubectl access for cluster operations and remediation
apiVersion: v1
kind: ServiceAccount
metadata:
  name: k8s-operator
  namespace: zi
  labels:
    app.kubernetes.io/component: agent
    app.kubernetes.io/part-of: zi-agents
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: zi-k8s-operator
  labels:
    app.kubernetes.io/component: agent
    app.kubernetes.io/part-of: zi-agents
rules:
  # Read access to cluster resources (for diagnostics)
  - apiGroups: [""]
    resources: [nodes, pods, services, namespaces, events, configmaps, persistentvolumeclaims]
    verbs: [get, list, watch]
  - apiGroups: ["apps"]
    resources: [deployments, replicasets, daemonsets, statefulsets]
    verbs: [get, list, watch]
  - apiGroups: ["batch"]
    resources: [jobs, cronjobs]
    verbs: [get, list, watch]
  # Pod logs access
  - apiGroups: [""]
    resources: [pods/log]
    verbs: [get, list]
  # Remediation: delete pods (RESTRICTED - requires approval)
  - apiGroups: [""]
    resources: [pods]
    verbs: [delete]
  # Remediation: rollout restart and scale deployments (SAFE/RESTRICTED)
  - apiGroups: ["apps"]
    resources: [deployments]
    verbs: [patch, update]
  - apiGroups: ["apps"]
    resources: [deployments/scale]
    verbs: [patch, update]
  # Flux resources (read-only for status)
  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
    resources: [kustomizations]
    verbs: [get, list, watch]
  - apiGroups: ["source.toolkit.fluxcd.io"]
    resources: [gitrepositories, helmrepositories]
    verbs: [get, list, watch]
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources: [helmreleases]
    verbs: [get, list, watch]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: zi-k8s-operator
  labels:
    app.kubernetes.io/component: agent
    app.kubernetes.io/part-of: zi-agents
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: zi-k8s-operator
subjects:
  - kind: ServiceAccount
    name: k8s-operator
    namespace: zi
