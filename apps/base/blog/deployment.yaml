apiVersion: apps/v1
kind: Deployment
metadata:
  name: hugo-blog
  namespace: blog
  labels:
    app.kubernetes.io/name: hugo-blog
    app.kubernetes.io/component: blog
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: hugo-blog
  template:
    metadata:
      labels:
        app.kubernetes.io/name: hugo-blog
    spec:
      containers:
      - name: hugo
        image: floryn90/hugo:0.134.0-ext-alpine
        command:
        - /bin/sh
        - -c
        - |
          # Create a fresh Hugo site
          cd /tmp
          hugo new site mysite
          cd mysite
          
          # Create basic config
          cat > hugo.toml <<'EOF'
          baseURL = 'https://blog.fako-cluster.local/'
          languageCode = 'en-us'
          title = 'Fako Cluster Documentation'
          EOF
          
          # Create minimal theme structure
          mkdir -p layouts/_default
          
          # Create base layout
          cat > layouts/_default/baseof.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <title>{{ .Title }} - {{ .Site.Title }}</title>
          </head>
          <body>
              <h1>{{ .Site.Title }}</h1>
              <main>
              {{ block "main" . }}{{ end }}
              </main>
          </body>
          </html>
          EOF
          
          # Create list layout
          cat > layouts/_default/list.html <<'EOF'
          {{ define "main" }}
          <h2>{{ .Title }}</h2>
          {{ .Content }}
          <ul>
          {{ range .Pages }}
              <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
          {{ end }}
          </ul>
          {{ end }}
          EOF
          
          # Create single layout
          cat > layouts/_default/single.html <<'EOF'
          {{ define "main" }}
          <article>
              <h2>{{ .Title }}</h2>
              {{ .Content }}
          </article>
          {{ end }}
          EOF
          
          # Create homepage layout
          cat > layouts/index.html <<'EOF'
          {{ define "main" }}
          <h2>Welcome to Fako Cluster Documentation</h2>
          <p>This is a simple documentation site for the Fako Cluster.</p>
          <ul>
              <li><a href="/docs/">Documentation</a></li>
          </ul>
          {{ end }}
          EOF
          
          # Create content
          mkdir -p content/docs
          
          cat > content/_index.md <<'EOF'
          ---
          title: "Home"
          ---
          Welcome to the documentation site.
          EOF
          
          cat > content/docs/_index.md <<'EOF'
          ---
          title: "Documentation"
          ---
          Browse all documentation here.
          EOF
          
          # Start Hugo server
          echo "Starting Hugo server..."
          exec hugo server --bind=0.0.0.0 --port=1313 --baseURL=https://blog.fako-cluster.local --appendPort=false
        ports:
        - containerPort: 1313
          name: http
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 20
          periodSeconds: 5
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
