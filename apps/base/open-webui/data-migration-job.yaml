# One-time job to copy data from ollama-webui to open-webui
apiVersion: batch/v1
kind: Job
metadata:
  name: webui-data-migration
  namespace: open-webui
spec:
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: data-copier
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              echo "Starting data migration from ollama-webui to open-webui..."
              
              # Create destination directory if it doesn't exist
              mkdir -p /dest/
              
              # Copy all data from source to destination
              if [ -d "/source" ] && [ "$(ls -A /source 2>/dev/null)" ]; then
                echo "Source data found, copying..."
                cp -r /source/* /dest/
                echo "Data copied successfully"
                
                # List what was copied
                echo "Files copied:"
                ls -la /dest/
              else
                echo "No source data found or source is empty, initializing fresh..."
                echo "Open WebUI will initialize with fresh data"
              fi
              
              # Ensure proper permissions
              chown -R 1000:1000 /dest/
              chmod -R 755 /dest/
              
              echo "Migration completed successfully"
          volumeMounts:
            - name: source-data
              mountPath: /source
              readOnly: true
            - name: dest-data
              mountPath: /dest
      volumes:
        - name: source-data
          persistentVolumeClaim:
            claimName: ollama-webui-data
        - name: dest-data
          persistentVolumeClaim:
            claimName: open-webui-data
      # Cross-namespace volume access - need to create a temporary pod in ollama-webui namespace
      # that mounts the volume and copies via shared NFS
  backoffLimit: 3
