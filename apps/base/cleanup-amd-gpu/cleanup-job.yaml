apiVersion: batch/v1
kind: Job
metadata:
  name: cleanup-amd-gpu
  namespace: cleanup-jobs
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: cleanup-admin
      restartPolicy: Never
      containers:
      - name: cleanup
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          echo "=== Starting AMD GPU Cleanup ==="
          
          # Remove node labels
          echo "Removing AMD GPU labels from playground node..."
          kubectl label nodes playground accelerator- --overwrite 2>/dev/null || true
          kubectl label nodes playground gpu.type- --overwrite 2>/dev/null || true
          kubectl label nodes playground gpu.model- --overwrite 2>/dev/null || true
          kubectl label nodes playground hardware.tier- --overwrite 2>/dev/null || true
          
          # Delete AMD GPU resources
          echo "Deleting AMD GPU DaemonSet..."
          kubectl delete daemonset -n gpu-system amd-gpu-device-plugin --force --grace-period=0 2>/dev/null || true
          
          # Delete pods using AMD GPU
          echo "Deleting pods requesting AMD GPU..."
          kubectl get pods -A -o json | jq -r '.items[] | select(.spec.containers[]?.resources.requests."amd.com/gpu" or .spec.containers[]?.resources.limits."amd.com/gpu") | "\(.metadata.namespace) \(.metadata.name)"' | while read ns pod; do
            echo "Deleting pod $ns/$pod"
            kubectl delete pod -n $ns $pod --force --grace-period=0 2>/dev/null || true
          done
          
          # Delete AMD GPU namespace
          echo "Deleting gpu-system namespace..."
          kubectl delete namespace gpu-system --force --grace-period=0 2>/dev/null || true
          
          # Clean up test namespaces
          echo "Cleaning up test namespaces..."
          for ns in gpu-test gpu-diagnostics gpu-status verify-gpu-node; do
            kubectl delete namespace $ns --force --grace-period=0 2>/dev/null || true
          done
          
          echo "=== AMD GPU Cleanup Complete ==="