apiVersion: batch/v1
kind: Job
metadata:
  name: nfs-ip-cleanup
  namespace: security-scanning
spec:
  template:
    spec:
      serviceAccountName: gitleaks
      containers:
      - name: ip-cleanup
        image: alpine:3.22
        env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-credentials
              key: token
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          # Install dependencies
          apk add --no-cache git bash curl openjdk11-jre
          
          # Download BFG
          echo "Downloading BFG Repo-Cleaner..."
          curl -L https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar \
            -o /tmp/bfg.jar
          
          # Configuration
          REPO_URL="https://github.com/lyzetam/fako-cluster.git"
          
          # Clone the repo
          echo "Cloning repository..."
          git config --global url."https://${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          git clone --mirror "$REPO_URL" /tmp/repo-mirror
          
          # Create replacements file for specific IPs
          echo "Creating IP replacement patterns..."
          cat > /tmp/ip-replacements.txt << 'EOF'
          ***REMOVED***
          ***NFS-IP-REMOVED***==>***NFS-IP-REMOVED***
          ***NFS-IP-REMOVED***==>***NFS-IP-REMOVED***
          
          # Match any IP in the 10.85.30.* or 10.85.35.* ranges
          regex:10\.85\.30\.\d{1,3}==>***NFS-IP-REMOVED***
          regex:10\.85\.35\.\d{1,3}==>***NFS-IP-REMOVED***
          EOF
          
          # Show what we're going to clean
          echo "Will clean the following IP patterns:"
          cat /tmp/ip-replacements.txt
          
          # Run BFG to clean the IPs
          echo "Running BFG to clean IPs from git history..."
          cd /tmp/repo-mirror
          java -jar /tmp/bfg.jar \
            --replace-text /tmp/ip-replacements.txt \
            --no-blob-protection \
            .
          
          # Clean up git
          echo "Cleaning up git repository..."
          git reflog expire --expire=now --all
          git gc --prune=now --aggressive
          
          echo "✅ IP addresses cleaned from history!"
          echo ""
          echo "⚠️  IMPORTANT: This is a destructive operation!"
          echo "The cleaned repository is at: /tmp/repo-mirror"
          echo ""
          echo "To push the cleaned history (THIS WILL REWRITE HISTORY):"
          echo "  cd /tmp/repo-mirror"
          echo "  git push --force --all"
          echo "  git push --force --tags"
          echo ""
          echo "Make sure all team members are aware before force pushing!"
          
          # Keep the pod running so you can inspect/push manually
          echo "Pod will stay running for 1 hour for manual inspection..."
          sleep 3600
        
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1"
      
      restartPolicy: Never
