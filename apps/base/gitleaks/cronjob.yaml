# apps/base/gitleaks/cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: gitleaks-scanner
  namespace: security-scanning
spec:
  schedule: "0 */6 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: gitleaks
          initContainers:
          # Install dependencies
          - name: setup
            image: alpine:latest
            command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache openjdk11-jre curl
              curl -L https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar \
                -o /tools/bfg.jar
            volumeMounts:
            - name: tools
              mountPath: /tools
          
          containers:
          - name: gitleaks
            image: zricethezav/gitleaks:latest
            env:
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-credentials
                  key: token
            - name: DRY_RUN
              value: "false"  # Start with dry run
            - name: AUTO_PUSH
              value: "false"  # Don't auto-push initially
            - name: SLACK_WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: slack-webhook
                  key: url
                  optional: true
            command:
            - /bin/sh
            - -c
            - |
              # Install additional tools
              apk add --no-cache git jq bash openjdk11-jre
              
              # Copy BFG from init container
              cp /tools/bfg.jar /usr/local/bin/
              
              # Run the cleanup script
              bash /scripts/cleanup.sh
            volumeMounts:
            - name: scripts
              mountPath: /scripts
            - name: tools
              mountPath: /tools
            - name: scan-results
              mountPath: /tmp/scan-results
            resources:
              requests:
                memory: "512Mi"
                cpu: "200m"
              limits:
                memory: "1Gi"
                cpu: "500m"
          
          volumes:
          - name: scripts
            configMap:
              name: gitleaks-cleanup-script
              defaultMode: 0755
          - name: tools
            emptyDir: {}
          - name: scan-results
            emptyDir: {}
          
          restartPolicy: OnFailure