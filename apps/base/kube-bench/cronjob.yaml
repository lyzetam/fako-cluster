apiVersion: batch/v1
kind: CronJob
metadata:
  name: kube-bench-scanner
  namespace: kube-bench
  labels:
    app.kubernetes.io/name: kube-bench
    app.kubernetes.io/part-of: security
spec:
  schedule: "0 2 * * *"  # Run daily at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: kube-bench
        spec:
          serviceAccountName: kube-bench
          hostPID: true
          imagePullSecrets:
          - name: dockerhub-registry
          containers:
          - name: kube-bench
            image: aquasec/kube-bench:v0.14.1
            command:
            - /bin/sh
            - -c
            - |
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              RESULT_FILE="/results/kube-bench-results-${TIMESTAMP}.json"
              echo "Starting K3s CIS benchmark scan..."
              echo "Results will be saved to ${RESULT_FILE}"

              # Run kube-bench with K3s-specific benchmark
              # K3s CIS 1.7 benchmark is designed for K3s distributions
              kube-bench run --benchmark k3s-cis-1.7 \
                --json \
                --outputfile "${RESULT_FILE}" \
                --logtostderr 2>&1

              EXIT_CODE=$?
              echo "Scan completed with exit code: ${EXIT_CODE}"
              echo "Results saved to: ${RESULT_FILE}"

              # Also output a human-readable summary
              echo ""
              echo "=== Quick Summary ==="
              kube-bench run --benchmark k3s-cis-1.7 2>/dev/null | tail -20

              exit 0
            volumeMounts:
            # K3s-specific paths
            - name: var-lib-rancher
              mountPath: /var/lib/rancher
              readOnly: true
            - name: etc-rancher
              mountPath: /etc/rancher
              readOnly: true
            # Standard paths that K3s also uses
            - name: var-lib-kubelet
              mountPath: /var/lib/kubelet
              readOnly: true
            - name: etc-cni-netd
              mountPath: /etc/cni/net.d/
              readOnly: true
            - name: opt-cni-bin
              mountPath: /opt/cni/bin/
              readOnly: true
            # System paths
            - name: etc-systemd
              mountPath: /etc/systemd
              readOnly: true
            - name: proc
              mountPath: /proc
              readOnly: true
            # Results storage
            - name: results-storage
              mountPath: /results
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"
            securityContext:
              privileged: true
          - name: results-processor
            image: busybox:1.37.0
            command:
            - /bin/sh
            - -c
            - |
              echo "Monitoring results directory for new scan results..."
              sleep 30  # Give kube-bench time to complete

              # Wait for the result file
              TIMEOUT=300
              ELAPSED=0
              while [ $ELAPSED -lt $TIMEOUT ]; do
                LATEST_FILE=$(ls -t /results/kube-bench-results-*.json 2>/dev/null | head -1)
                if [ -n "$LATEST_FILE" ] && [ -s "$LATEST_FILE" ]; then
                  echo "Found latest scan result: $LATEST_FILE"
                  echo "=== K3s CIS Benchmark Results ==="

                  # Parse and display summary using basic tools
                  echo "File size: $(wc -c < "$LATEST_FILE") bytes"
                  echo ""
                  echo "Results saved to: $LATEST_FILE"
                  break
                fi
                sleep 5
                ELAPSED=$((ELAPSED + 5))
              done

              if [ $ELAPSED -ge $TIMEOUT ]; then
                echo "Timeout waiting for results file"
                exit 1
              fi
            volumeMounts:
            - name: results-storage
              mountPath: /results
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"
          volumes:
          # K3s-specific paths
          - name: var-lib-rancher
            hostPath:
              path: "/var/lib/rancher"
              type: DirectoryOrCreate
          - name: etc-rancher
            hostPath:
              path: "/etc/rancher"
              type: DirectoryOrCreate
          # Standard Kubernetes paths
          - name: var-lib-kubelet
            hostPath:
              path: "/var/lib/kubelet"
              type: DirectoryOrCreate
          - name: etc-cni-netd
            hostPath:
              path: "/etc/cni/net.d/"
              type: DirectoryOrCreate
          - name: opt-cni-bin
            hostPath:
              path: "/opt/cni/bin/"
              type: DirectoryOrCreate
          # System paths
          - name: etc-systemd
            hostPath:
              path: "/etc/systemd"
              type: DirectoryOrCreate
          - name: proc
            hostPath:
              path: "/proc"
              type: ""
          # Results storage
          - name: results-storage
            persistentVolumeClaim:
              claimName: kube-bench-results
          restartPolicy: OnFailure
          # Schedule on control plane node for complete scan
          nodeSelector:
            kubernetes.io/os: linux
            node-role.kubernetes.io/control-plane: "true"
          tolerations:
          - key: "node-role.kubernetes.io/control-plane"
            operator: "Exists"
            effect: "NoSchedule"
          - key: "node-role.kubernetes.io/master"
            operator: "Exists"
            effect: "NoSchedule"
