apiVersion: batch/v1
kind: Job
metadata:
  name: gpu-node-check
  namespace: gpu-verification
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      runtimeClassName: nvidia
      nodeSelector:
        kubernetes.io/hostname: playground
        nvidia.com/gpu: "true"
      tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
      restartPolicy: Never
      containers:
      - name: gpu-check
        image: nvidia/cuda:12.2-base-ubuntu22.04
        command:
        - bash
        - -c
        - |
          echo "=== GPU Node Verification ==="
          echo "Node: $(hostname)"
          echo "Date: $(date)"
          
          # Check NVIDIA driver
          if nvidia-smi; then
            echo "✓ NVIDIA GPU detected and working"
            
            # Show GPU details
            nvidia-smi --query-gpu=name,memory.total,driver_version --format=csv
            
            # Check CUDA
            if command -v nvcc >/dev/null 2>&1; then
              nvcc --version
            fi
            
            # Check devices
            ls -la /dev/nvidia* || echo "No nvidia devices in /dev"
            
            echo "✓ GPU verification successful"
          else
            echo "✗ No GPU detected or drivers not working"
            exit 1
          fi
        resources:
          limits:
            nvidia.com/gpu: 1
          requests:
            nvidia.com/gpu: 1