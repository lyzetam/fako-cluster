apiVersion: batch/v1
kind: CronJob
metadata:
  name: voice-pipeline-test-trigger
  namespace: voice-pipeline-test
spec:
  # Run every night at 3am EST (7am UTC)
  schedule: "0 7 * * *"
  successfulJobsHistoryLimit: 7  # Keep last 7 successful runs
  failedJobsHistoryLimit: 3      # Keep last 3 failed runs
  concurrencyPolicy: Forbid      # Don't run concurrent tests
  jobTemplate:
    spec:
      backoffLimit: 2  # Retry up to 2 times on failure
      template:
        metadata:
          labels:
            app: voice-pipeline-test-trigger
        spec:
          restartPolicy: Never
          containers:
            - name: trigger
              image: curlimages/curl:latest
              command:
                - sh
                - -c
                - |
                  echo "Triggering voice pipeline test at $(date)"
                  curl -X POST \
                    -H "Content-Type: application/json" \
                    -d '{"timeout": 120}' \
                    http://voice-pipeline-test.voice-pipeline-test:8080/test \
                    -w "\n\nHTTP Status: %{http_code}\n" \
                    -o /dev/stdout
                  exit_code=$?
                  echo "Test trigger completed at $(date) with exit code: $exit_code"
                  exit $exit_code
              resources:
                requests:
                  memory: "32Mi"
                  cpu: "10m"
                limits:
                  memory: "64Mi"
                  cpu: "50m"
