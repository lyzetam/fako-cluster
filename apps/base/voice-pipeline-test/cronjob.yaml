apiVersion: batch/v1
kind: CronJob
metadata:
  name: voice-pipeline-test-trigger
  namespace: voice-pipeline-test
spec:
  # Run every 15 minutes for continuous monitoring
  schedule: "*/15 * * * *"
  successfulJobsHistoryLimit: 10  # Keep last 10 successful runs
  failedJobsHistoryLimit: 5       # Keep last 5 failed runs
  concurrencyPolicy: Forbid      # Don't run concurrent tests
  jobTemplate:
    spec:
      backoffLimit: 2  # Retry up to 2 times on failure
      template:
        metadata:
          labels:
            app: voice-pipeline-test-trigger
        spec:
          restartPolicy: Never
          containers:
            - name: trigger
              image: busybox:1.37
              command:
                - sh
                - -c
                - |
                  echo "Triggering voice pipeline test at $(date)"
                  # Call the test endpoint and capture response
                  if wget -O- --post-data='{"timeout": 120}' \
                    --header='Content-Type: application/json' \
                    http://voice-pipeline-test.voice-pipeline-test:8080/test \
                    2>&1; then
                    echo "Test completed successfully"
                  else
                    # Even if wget returns error (HTTP 207/500), consider it success
                    # since the test ran and metrics were sent to New Relic
                    echo "Test completed (may have detected pipeline issues)"
                  fi
                  echo "Test trigger completed at $(date)"
                  # Always exit successfully - actual test results are in New Relic
                  exit 0
              resources:
                requests:
                  memory: "32Mi"
                  cpu: "10m"
                limits:
                  memory: "64Mi"
                  cpu: "50m"
