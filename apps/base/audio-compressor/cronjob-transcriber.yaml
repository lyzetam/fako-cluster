apiVersion: batch/v1
kind: CronJob
metadata:
  name: audio-transcriber
  namespace: audio-compressor
spec:
  schedule: "0 4 * * *"  # Run at 4 AM daily (2 hours after compressor)
  concurrencyPolicy: Forbid  # Prevent job pile-up if previous job still running
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: audio-compressor
          restartPolicy: OnFailure
          imagePullSecrets:
          - name: dockerhub-registry
          nodeSelector:
            kubernetes.io/hostname: pglenovo01
          containers:
          - name: audio-transcriber
            image: lzetam/audio-transcriber:latest
            imagePullPolicy: Always
            envFrom:
            - configMapRef:
                name: audio-transcriber-config
            env:
            # Use internal Kubernetes service (faster, no proxy timeout)
            - name: WHISPER_BASE_URL
              value: "http://whisper-gpu.whisper.svc.cluster.local:10300"
            - name: WHISPER_API_KEY
              value: "not-required"  # Internal service doesn't need auth
            volumeMounts:
            - name: compressed-audio
              mountPath: /data/compressed
              readOnly: true
            - name: transcriptions
              mountPath: /data/transcriptions
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "1Gi"
                cpu: "500m"
          volumes:
          - name: compressed-audio
            nfs:
              server: ugnas.landryzetam.net
              path: /volume1/k8s-storage/pvc-fa625048-6545-4904-bc35-7111a93b21bc
          - name: transcriptions
            nfs:
              server: ugnas.landryzetam.net
              path: /volume1/k8s-storage/pvc-1a863515-490c-4c4a-8aaa-f63ce16b8ecc
