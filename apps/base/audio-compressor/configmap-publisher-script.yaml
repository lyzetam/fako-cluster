apiVersion: v1
kind: ConfigMap
metadata:
  name: transcript-publisher-script
  namespace: audio-compressor
data:
  publisher.py: |
    #!/usr/bin/env python3
    """
    Transcript Publisher - Posts raw transcripts to Obsidian vault
    """
    import os
    import json
    import logging
    import textwrap
    import urllib.request
    import urllib.error
    from pathlib import Path
    from datetime import datetime
    import time

    # Configuration from environment
    INPUT_DIR = os.environ.get('INPUT_DIR', '/data/transcriptions')
    STATE_DIR = os.environ.get('STATE_DIR', '/data/state')
    OBSIDIAN_FOLDER = os.environ.get('OBSIDIAN_FOLDER', 'Transcripts/Raw')
    OBSIDIAN_API_URL = os.environ['OBSIDIAN_API_URL']
    OBSIDIAN_API_KEY = os.environ['OBSIDIAN_API_KEY']
    SKIP_PROCESSED = os.environ.get('SKIP_PROCESSED', 'true').lower() == 'true'
    FILE_PREFIX = os.environ.get('FILE_PREFIX', 'Transcript')
    MAX_RETRIES = int(os.environ.get('MAX_RETRIES', '3'))
    RETRY_DELAY = int(os.environ.get('RETRY_DELAY', '10'))
    LOG_LEVEL = os.environ.get('LOG_LEVEL', 'INFO')

    logging.basicConfig(level=getattr(logging, LOG_LEVEL),
                        format='%(asctime)s - %(levelname)s - %(message)s')
    logger = logging.getLogger(__name__)

    STATE_FILE = Path(STATE_DIR) / 'publisher-processed.txt'

    def load_processed():
        if STATE_FILE.exists():
            return set(STATE_FILE.read_text().strip().split('\n'))
        return set()

    def save_processed(processed):
        STATE_FILE.parent.mkdir(parents=True, exist_ok=True)
        STATE_FILE.write_text('\n'.join(sorted(processed)))

    def json_to_markdown(data, filename):
        """Convert Whisper JSON transcript to readable Markdown."""
        text = data.get('text', '')
        duration = data.get('duration', 0)
        language = data.get('language', 'unknown')

        # Format duration
        mins, secs = divmod(int(duration), 60)
        hours, mins = divmod(mins, 60)
        duration_str = f"{hours}h {mins}m {secs}s" if hours else f"{mins}m {secs}s"

        md = textwrap.dedent(f"""\
            # {FILE_PREFIX}: {filename}

            **Generated**: {datetime.now().strftime('%Y-%m-%d %H:%M')}
            **Duration**: {duration_str}
            **Language**: {language}

            ---

            ## Full Transcript

            {text}

            ---

            *Published by transcript-publisher*
            """)
        return md

    def post_to_obsidian(filename, content):
        """Post markdown content to Obsidian REST API."""
        url = f"{OBSIDIAN_API_URL}/vault/{OBSIDIAN_FOLDER}/{filename}"
        headers = {
            'Authorization': f'Bearer {OBSIDIAN_API_KEY}',
            'Content-Type': 'text/markdown'
        }

        for attempt in range(MAX_RETRIES):
            try:
                req = urllib.request.Request(url, data=content.encode('utf-8'), headers=headers, method='PUT')
                with urllib.request.urlopen(req) as response:
                    if response.status in (200, 201, 204):
                        logger.info(f"Posted {filename} to Obsidian")
                        return True
                    logger.warning(f"Obsidian API returned {response.status}")
            except urllib.error.HTTPError as e:
                logger.warning(f"Obsidian API returned {e.code}: {e.reason}")
            except Exception as e:
                logger.error(f"Attempt {attempt+1} failed: {e}")

            if attempt < MAX_RETRIES - 1:
                time.sleep(RETRY_DELAY)

        return False

    def main():
        logger.info(f"Starting transcript publisher")
        logger.info(f"Input: {INPUT_DIR}, Output: {OBSIDIAN_FOLDER}")

        processed = load_processed() if SKIP_PROCESSED else set()
        input_path = Path(INPUT_DIR)

        json_files = list(input_path.glob('*.json'))
        logger.info(f"Found {len(json_files)} JSON files")

        success_count = 0
        for json_file in json_files:
            if json_file.name in processed:
                logger.debug(f"Skipping already processed: {json_file.name}")
                continue

            try:
                data = json.loads(json_file.read_text())
                md_content = json_to_markdown(data, json_file.stem)
                md_filename = f"{json_file.stem}.md"

                if post_to_obsidian(md_filename, md_content):
                    processed.add(json_file.name)
                    success_count += 1
            except Exception as e:
                logger.error(f"Failed to process {json_file.name}: {e}")

        save_processed(processed)
        logger.info(f"Published {success_count} transcripts to Obsidian")

    if __name__ == '__main__':
        main()
