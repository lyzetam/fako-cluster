apiVersion: apps/v1
kind: Deployment
metadata:
  name: hugo-blog
  namespace: blog
spec:
  template:
    spec:
      containers:
      - name: hugo
        image: hugomods/hugo:exts-0.148.2  # Latest Hugo 0.148.2 with extended features
        command:
        - /bin/sh
        - -c
        - |
          # Create site directory structure
          mkdir -p /site/themes
          mkdir -p /site/content
          mkdir -p /site/static
          mkdir -p /site/layouts
          mkdir -p /site/archetypes
          
          # Download and extract Hugo Book theme (latest version)
          echo "Downloading Hugo Book theme (latest version for Hugo 0.148.2)..."
          cd /site/themes
          if [ ! -d "hugo-book" ]; then
            wget -q https://github.com/alex-shpak/hugo-book/archive/master.tar.gz
            tar -xzf master.tar.gz
            mv hugo-book-master hugo-book
            rm master.tar.gz
          fi
          
          # Create/update Hugo configuration
          cat > /site/config.toml <<'EOF'
          baseURL = 'https://blog.landryzetam.net/'
          title = 'Fako Cluster Documentation'
          theme = 'hugo-book'
          
          # Book configuration
          disablePathToLower = true
          enableGitInfo = false  # Disable git info to avoid errors
          
          # Needed for proper theme rendering
          [params]
            # (Optional, default light) Sets color theme: light, dark or auto.
            # Theme 'auto' switches between dark and light modes based on browser/os preferences
            BookTheme = 'auto'
            
            # Enable search
            BookSearch = true
            
            # Show/hide table of contents
            BookToC = true
            
            # Set source repository location for edit links
            BookRepo = 'https://github.com/lyzetam/fako-cluster'
            
            # Configure edit link
            BookEditPath = 'edit/main'
            
            # Logo for the book
            BookLogo = ''
            
            # Enable "Copy to clipboard" buttons for code blocks
            BookComments = false
            
            # Custom site description
            BookDescription = 'Complete documentation for the Fako Cluster - Services, Architecture, and Operations'
            
            # Hide next/prev page navigation
            BookShowPrevNext = true
            
            # Enable breadcrumb navigation
            BookBreadcrumb = true
            
            # Collapse menu by default
            BookMenuCollapseDefault = false
            
            # Auto-collapse menu for mobile
            BookMobileCollapse = true
            
            # Custom CSS
            customCSS = []
            
          # Multi-level menu configuration
          [[menu.before]]
            name = "GitHub"
            url = "https://github.com/lyzetam/fako-cluster"
            weight = 10
            
          [[menu.after]]
            name = "⬅ Back to Cluster"
            url = "https://headlamp.landryzetam.net"
            weight = 20
            
          # Configure sections to appear in menu
          [params.bookSection]
            # Show sections in menu even if they have no content
            showInMenu = true
          
          # Markup configuration for better rendering
          [markup]
            [markup.goldmark]
              [markup.goldmark.renderer]
                unsafe = true
            [markup.tableOfContents]
              startLevel = 1
              endLevel = 4
            [markup.highlight]
              anchorLineNos = false
              codeFences = true
              guessSyntax = true
              hl_Lines = ''
              hl_inline = false
              lineAnchors = ''
              lineNoStart = 1
              lineNos = false
              lineNumbersInTable = true
              noClasses = false
              noHl = false
              style = 'monokai'
              tabWidth = 4
          
          # Output configuration
          [outputs]
            home = ['HTML', 'RSS', 'JSON']
          
          # Configure search
          [outputFormats.SearchIndex]
            mediaType = "application/json"
            baseName = "search"
          EOF
          
          # Create custom CSS for additional styling
          mkdir -p /site/assets
          cat > /site/assets/_custom.scss <<'EOF'
          /* Custom styles for Fako documentation */
          .book-brand {
            font-weight: 600;
          }
          
          /* Add some custom colors */
          :root {
            --body-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
          }
          
          /* Dark mode enhancements */
          @media (prefers-color-scheme: dark) {
            :root {
              --gray-100: #1a1a1a;
            }
          }
          
          /* Code block improvements */
          .highlight pre {
            padding: 1rem;
            border-radius: 4px;
          }
          EOF
          
          # Create an archetype for documentation pages
          cat > /site/archetypes/docs.md <<'EOF'
          ---
          title: "{{ replace .Name "-" " " | title }}"
          weight: 1
          # bookFlatSection: false
          # bookToc: true
          # bookHidden: false
          # bookCollapseSection: false
          # bookComments: false
          # bookSearchExclude: false
          ---
          
          # {{ replace .Name "-" " " | title }}
          
          ## Overview
          
          ## Configuration
          
          ## Usage
          
          ## Troubleshooting
          EOF
          
          # Create a proper content structure if it doesn't exist
          if [ ! -f "/site/content/_index.md" ]; then
            cat > /site/content/_index.md <<'EOF'
          ---
          title: Introduction
          type: docs
          ---
          
          # Fako Cluster Documentation
          
          Welcome to the comprehensive documentation for the **Fako Cluster**. This documentation covers all services, infrastructure components, and operational procedures.
          
          ## Quick Start
          
          {{< columns >}}
          ### Services
          
          Explore the [Services Documentation]({{< relref "/docs/services" >}}) to learn about each component in the cluster.
          
          <--->
          
          ### Use Cases
          
          Check out [Active Use Cases]({{< relref "/docs/use-cases" >}}) to see real-world implementations.
          
          {{< /columns >}}
          
          ## Documentation Structure
          
          {{< hint info >}}
          **Note:** Documentation is automatically synchronized from the GitHub repository every 6 hours.
          {{< /hint >}}
          
          - **[Services]({{< relref "/docs/services" >}})** - Detailed documentation for each service
          - **[Use Cases]({{< relref "/docs/use-cases" >}})** - Real-world implementations and examples  
          - **[Architecture]({{< relref "/docs/architecture" >}})** - System design and architecture
          - **[Guides]({{< relref "/docs/guides" >}})** - Step-by-step tutorials
          - **[Operations]({{< relref "/docs/operations" >}})** - Operational procedures
          
          ## Features
          
          - 🌙 **Dark Mode** - Toggle between light and dark themes
          - 🔍 **Search** - Full-text search across all documentation
          - 📱 **Mobile Friendly** - Responsive design for all devices
          - 📑 **Table of Contents** - Auto-generated for easy navigation
          
          ## Manual Documentation Sync
          
          To manually trigger a documentation sync from GitHub:
          
          ```bash
          kubectl create job --from=cronjob/sync-docs -n blog sync-docs-manual-$(date +%s)
          ```
          EOF
          fi
          
          # Ensure docs directory exists
          mkdir -p /site/content/docs
          
          if [ ! -f "/site/content/docs/_index.md" ]; then
            cat > /site/content/docs/_index.md <<'EOF'
          ---
          title: "Documentation"
          bookFlatSection: true
          weight: 1
          ---
          
          # Documentation
          
          Browse all documentation for the Fako Cluster.
          EOF
          fi
          
          # Create placeholder sections if they don't exist
          for section in services use-cases architecture guides operations; do
            mkdir -p "/site/content/docs/$section"
            if [ ! -f "/site/content/docs/$section/_index.md" ]; then
              title=$(echo "$section" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
              cat > "/site/content/docs/$section/_index.md" <<EOF
          ---
          title: "$title"
          weight: 10
          bookCollapseSection: true
          ---
          
          # $title
          
          This section contains documentation about $section.
          EOF
            fi
          done
          
          # Start Hugo server
          cd /site
          echo "Starting Hugo server with Book theme..."
          exec hugo server \
            --bind=0.0.0.0 \
            --port=1313 \
            --baseURL=https://blog.landryzetam.net \
            --appendPort=false \
            --disableFastRender \
            --theme=hugo-book \
            --themesDir=/site/themes
        volumeMounts:
        - name: content
          mountPath: /site
      volumes:
      - name: content
        persistentVolumeClaim:
          claimName: blog-content
