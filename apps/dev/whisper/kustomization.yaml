apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: dev-whisper
resources:
  - ../../base/whisper/

patches:
  - target:
      kind: Service
      name: whisper-nodeport
    patch: |-
      - op: replace
        path: /spec/ports/0/nodePort
        value: 30301
  - target:
      kind: Deployment
      name: whisper-gpu
    patch: |-
      - op: remove
        path: /spec/template/spec/nodeSelector
      - op: remove
        path: /spec/template/spec/tolerations/0
      - op: remove
        path: /spec/template/spec/runtimeClassName
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: rhasspy/wyoming-whisper:latest
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "1Gi"
            cpu: "1000m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
      - op: add
        path: /spec/template/spec/containers/0/command
        value:
          - python3
          - -m
          - wyoming_faster_whisper
          - --model
          - tiny
          - --uri
          - tcp://0.0.0.0:10300
          - --data-dir
          - /data
          - --download-dir
          - /data
          - --device
          - cpu
          - --language
          - en
          - --compute-type
          - int8
          - --beam-size
          - "1"
      - op: replace
        path: /spec/template/spec/containers/0/env
        value: []
