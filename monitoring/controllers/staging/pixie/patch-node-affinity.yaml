# Node affinity patch to ensure Pixie/Vizier runs only on x86 nodes (eBPF requirement)
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: pixie-operator
  namespace: pixie-system
spec:
  values:
    vizier:
      # Common node affinity for all Pixie components to ensure x86-only deployment
      nodeSelector:
        kubernetes.io/arch: amd64
      
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                - amd64
              - key: node.kubernetes.io/architecture  
                operator: In
                values:
                - x86_64
        # Anti-affinity for ARM nodes
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                - arm64
            topologyKey: kubernetes.io/hostname
      
      # Apply node affinity to all components
      kelvin:
        nodeSelector:
          kubernetes.io/arch: amd64
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
              - matchExpressions:
                - key: kubernetes.io/arch
                  operator: In
                  values:
                  - amd64
                - key: node.kubernetes.io/architecture
                  operator: NotIn
                  values:
                  - arm64
      
      pem:
        nodeSelector:
          kubernetes.io/arch: amd64
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
              - matchExpressions:
                - key: kubernetes.io/arch
                  operator: In
                  values:
                  - amd64
                - key: node.kubernetes.io/architecture
                  operator: NotIn
                  values:
                  - arm64
        # Add tolerations to exclude ARM nodes
        tolerations:
        - key: node-type
          operator: Equal
          value: arm
          effect: NoSchedule
        - key: node-type
          operator: Equal
          value: arm-mac
          effect: NoSchedule
      
      nats:
        nodeSelector:
          kubernetes.io/arch: amd64
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
              - matchExpressions:
                - key: kubernetes.io/arch
                  operator: In
                  values:
                  - amd64
      
      # Ensure cloud connector also runs on x86
      cloud_connector:
        nodeSelector:
          kubernetes.io/arch: amd64
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
              - matchExpressions:
                - key: kubernetes.io/arch
                  operator: In
                  values:
                  - amd64
