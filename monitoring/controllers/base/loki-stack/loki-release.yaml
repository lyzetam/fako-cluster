# monitoring/controllers/base/loki-stack/loki-release.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: loki-stack
spec:
  interval: 30m
  chart:
    spec:
      chart: loki
      version: "6.30.1"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: loki-stack
  install:
    crds: Create
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  values:
    # Use single binary deployment for simplicity
    deploymentMode: SingleBinary
    
    loki:
      # Disable auth
      auth_enabled: false
      
      # Common config with replication_factor: 1 for single binary
      commonConfig:
        replication_factor: 1
      
      # Configure storage - REQUIRED for filesystem
      storage:
        type: filesystem
        bucketNames:
          chunks: chunks
          ruler: ruler
          admin: admin
      
      # Schema config  
      schemaConfig:
        configs:
          - from: "2024-01-01"
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: loki_index_
              period: 24h
    
    # Single Binary specific configuration
    singleBinary:
      replicas: 1
      
      # Persistence configuration
      persistence:
        enabled: true
        storageClass: nfs-csi-v2
        size: 100Gi
      
      # Resources
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 1000m
          memory: 2Gi
    
    # Disable microservices mode components
    backend:
      replicas: 0
    
    read:
      replicas: 0
    
    write:
      replicas: 0
    
#     # Gateway configuration
#     gateway:
#       enabled: true
#       replicas: 1
#       resources:
#         requests:
#           cpu: 100m
#           memory: 128Mi
#         limits:
#           cpu: 500m
#           memory: 512Mi
#       ingress:
#         enabled: true
#         ingressClassName: traefik
#         hosts:
#           - host: loki.landryzetam.net
#             paths:
#               - path: /
#                 pathType: Prefix
    
#     # Monitoring
#     monitoring:
#       dashboards:
#         enabled: true
#         namespace: monitoring
#         labels:
#           grafana_dashboard: "1"
#       rules:
#         enabled: true
#         alerting: true
#       serviceMonitor:
#         enabled: true
#         labels:
#           prometheus: kube-prometheus
#       selfMonitoring:
#         enabled: false
    
#     # Test
#     test:
#       enabled: false
    
#     # Service account
#     serviceAccount:
#       create: true
#       name: loki
#       automountServiceAccountToken: true
