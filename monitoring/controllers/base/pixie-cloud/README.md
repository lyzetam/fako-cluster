# Self-Hosted Pixie Cloud Setup

This directory contains the GitOps configuration for deploying a fully self-hosted Pixie Cloud instance in your Kubernetes cluster.

## Architecture Overview

Self-hosted Pixie consists of two main components:

1. **Pixie Cloud** - The control plane that provides:
   - Web UI for accessing Pixie
   - Query engine for executing PxL scripts
   - User authentication and management
   - Data storage and retention

2. **Pixie Vizier** - The data plane that:
   - Collects observability data using eBPF
   - Executes queries from Pixie Cloud
   - Manages data collection agents (PEMs)

## Components

### Dependencies (`dependencies/`)
- **Elasticsearch**: Time-series data storage
- **PostgreSQL**: Metadata and user data storage
- **Redis**: Caching layer
- **NATS**: Message queue for real-time data streaming
- **Elastic Operator**: Manages Elasticsearch deployment

### Core Services (`components/`)
- **API Server**: REST/gRPC API backend
- **Auth Service**: Authentication with Kratos/Hydra
- **Cloud Proxy**: Main frontend service
- **VZConn**: Vizier connection manager
- **Profile Service**: User/org management
- **Script Manager**: PxL script storage
- **DNS Manager**: Internal DNS resolution
- **Cron Service**: Scheduled tasks

### Secrets (`secrets/`)
- TLS certificates (generated by mkcert)
- Authentication secrets
- Database credentials
- JWT signing keys

### Setup Jobs (`setup/`)
- **init-secrets**: Generates TLS certificates using mkcert
- **create-admin**: Creates initial admin user

## Deployment Process

### Prerequisites

1. **Kubernetes cluster** with:
   - BPF support (kernel 4.14+)
   - Persistent volume support
   - LoadBalancer service support (or use port-forward)
   - At least 8GB RAM and 4 CPU cores available

2. **DNS setup** (choose one):
   - Access to modify DNS records for `dev.withpixie.dev`
   - Or use port-forwarding for local testing

### Step 1: Deploy Pixie Cloud

The GitOps configuration will automatically:
1. Create the `plc` namespace
2. Deploy all dependencies (Elasticsearch, PostgreSQL, etc.)
3. Create secrets and TLS certificates
4. Deploy Pixie Cloud components
5. Run setup jobs to initialize the system

To deploy:
```bash
# If using Flux, it will be deployed automatically when you commit
# For manual deployment:
kubectl apply -k monitoring/controllers/staging/pixie-cloud
```

### Step 2: Wait for Services to be Ready

Monitor the deployment:
```bash
# Watch all pods in plc namespace
kubectl get pods -n plc -w

# Check if LoadBalancer services have external IPs
kubectl get svc -n plc cloud-proxy-service vzconn-service
```

### Step 3: Configure DNS

#### Option A: Real DNS (Recommended)
Point these DNS records to your LoadBalancer IPs:
- `dev.withpixie.dev` → cloud-proxy-service EXTERNAL-IP
- `work.dev.withpixie.dev` → vzconn-service EXTERNAL-IP

#### Option B: Port Forwarding (For Testing)
```bash
# Terminal 1: Forward cloud proxy
kubectl port-forward -n plc svc/cloud-proxy-service 8443:443

# Terminal 2: Forward vzconn
kubectl port-forward -n plc svc/vzconn-service 51800:51800
```

Then add to `/etc/hosts`:
```
127.0.0.1 dev.withpixie.dev work.dev.withpixie.dev
```

### Step 4: Install Pixie CLI

```bash
# Set cloud address
export PX_CLOUD_ADDR=dev.withpixie.dev

# Install CLI
bash -c "$(curl -fsSL https://withpixie.ai/install.sh)"

# Verify connection
px version
```

### Step 5: Access Pixie UI

1. Open Chrome browser (Safari/Firefox have known issues)
2. Navigate to: `https://dev.withpixie.dev`
3. Login with default credentials:
   - Email: `admin@default.com`
   - Password: `admin`
4. **IMPORTANT**: Change the admin password immediately!

### Step 6: Deploy Pixie Vizier

The Pixie operator is already configured to use your self-hosted cloud. It will be deployed automatically via GitOps.

To verify vizier is connected:
```bash
# Check vizier pods
kubectl get pods -n pixie-system

# Use CLI to verify connection
px get viziers
```

## Configuration Options

### Custom Domain

To use a custom domain instead of `dev.withpixie.dev`:

1. Update the domain in secrets:
   ```yaml
   # monitoring/controllers/base/pixie-cloud/secrets/pixie-secrets.yaml
   data:
     PL_DOMAIN_NAME: "pixie.yourdomain.com"
   ```

2. Update all references to `dev.withpixie.dev` in:
   - Auth service configurations
   - Kratos/Hydra configurations
   - TLS certificate generation

3. Update vizier cloud address:
   ```yaml
   # monitoring/controllers/base/pixie/release.yaml
   cloudAddr: "pixie.yourdomain.com:443"
   ```

### Resource Adjustments

Modify resource requests/limits in the staging overlay if needed:
```yaml
# monitoring/controllers/staging/pixie-cloud/kustomization.yaml
```

### Production Considerations

1. **Change all default passwords and secrets**
2. **Use proper TLS certificates** (cert-manager instead of mkcert)
3. **Configure persistent storage** with appropriate backup strategy
4. **Set up monitoring** for Pixie Cloud components
5. **Configure resource limits** based on cluster size
6. **Enable network policies** for security
7. **Set appropriate data retention** policies

## Troubleshooting

### Pods not starting
```bash
# Check pod logs
kubectl logs -n plc <pod-name>

# Check events
kubectl get events -n plc --sort-by='.lastTimestamp'
```

### Can't access UI
1. Verify LoadBalancer IPs are assigned
2. Check DNS resolution: `nslookup dev.withpixie.dev`
3. Verify TLS certificates are created: `kubectl get secrets -n plc`
4. Check cloud-proxy logs: `kubectl logs -n plc -l app=cloud-proxy-server`

### Vizier not connecting
1. Check vizier logs: `kubectl logs -n pixie-system -l name=vizier-cloud-connector`
2. Verify cloud address is correct in vizier config
3. Ensure vzconn-service is accessible from vizier namespace

### Database connection issues
1. Check PostgreSQL is running: `kubectl get pods -n plc -l app=postgres`
2. Verify database secrets: `kubectl get secret pl-db-secrets -n plc -o yaml`
3. Test connection manually from a pod

## Maintenance

### Backup
Regular backups should include:
- PostgreSQL database
- Elasticsearch indices
- Persistent volumes

### Updates
To update Pixie Cloud:
1. Update image tags in component deployments
2. Apply changes via GitOps
3. Monitor rollout: `kubectl rollout status -n plc deployment/<component>`

### Monitoring
Key metrics to monitor:
- Pod resource usage
- Database disk usage
- Service response times
- Error rates in logs

## Architecture Details

### Data Flow
1. Vizier collects data using eBPF probes
2. Data is sent to VZConn service via gRPC
3. VZConn streams data to NATS
4. Query engine processes data from NATS/Elasticsearch
5. Results are returned to UI/CLI via API server

### Security
- All communication uses TLS
- JWT tokens for authentication
- RBAC for authorization
- Network policies for pod-to-pod communication

## Additional Resources

- [Pixie Documentation](https://docs.px.dev/)
- [Pixie GitHub Repository](https://github.com/pixie-io/pixie)
- [PxL Script Reference](https://docs.px.dev/reference/pxl/)
- [Troubleshooting Guide](https://docs.px.dev/troubleshooting/)
